<!doctype html>
<html>
    <head>
        <meta charset=utf-8>
        <title>zkLambda demo</title>

        <script type="module">
            var proof = "";
            import init, { verify } from "./pkg/verifier.js";
            init().then(() => {
                var form = document.getElementById('formid');
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    const form = e.currentTarget;
                    const url = form.action;

                    try {
                        const formData = new FormData(form);
                        fetch(url, {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(response => {
                            const poll = setInterval(() => {
                                fetch('/job/' + response, {
                                    method: 'GET'
                                })
                                .then(response => response.json())
                                .then(response => {
                                    console.log(response.status)
                                    if (response.status == "queued" || response.status == "processing") {
                                        setStatus(response.status)
                                    } else {
                                        clearInterval(poll);
                                        if (response.status == "done") {
                                            init().then(() => {
                                                console.log("verifying")
                                                let result = verify(response.data)
                                                console.log("result: " + result)
                                                if (result == true) {
                                                    setStatus("verified")
                                                    proof = response.data
                                                    let json = JSON.parse(response.data)
                                                    document.getElementById('result').innerHTML = json.outputs
                                                    document.getElementById('proof').innerHTML = '<button id="download">Download proof</button>'
                                                    document.getElementById('download').addEventListener('click', download_proof)                                                    
                                                } else {
                                                    setStatus("not verified")
                                                }
                                            })
                                        }
                                    }
                                })
                            }, 1000);
                        })
                    } catch (error) {
                        console.error(error);
                    }
                }
            });                                            

            function setStatus(status) {
                document.getElementById('status').innerHTML = status;
            }

            function download_proof() {
                var hiddenElement = document.createElement('a');
                hiddenElement.href = 'data:attachment/text,' + encodeURI(proof);
                hiddenElement.target = '_blank';
                hiddenElement.download = 'proof.json';
                hiddenElement.click();
            }


        </script>

    </head>
    <body>
        <h3>zkLambda</h3>
        <form id="formid" action=/job method=POST enctype="multipart/form-data">
            <label>
                Input parameters:
                <input name="input">
            </label>
            <label>
                Code:
            <input type="file" name="code">
            </label>
            <button type=submit>Compute</button>
        </form>
        <div id="status"></div>
        <div id="result"></div>
        <div id="proof"></div>
</body>
</html>